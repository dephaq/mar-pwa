# agents.md — Оркестрация мульти-агентов для разработки MAR PWA

## Как этим пользоваться
Запускайте группы агентов **параллельно там, где нет жёстких зависимостей**, и последовательно — где завязки на результаты предыдущих групп. Каждый агент получает «Контекст», «Цель», «Входы», «Выходы» и **точный промпт**. Менеджер запуска отмечает статусы и склеивает результаты.


Глобальные соглашения (для всех агентов)

Node/Tooling: Node ≥ 20.x, npm (или pnpm — если хотите, но тогда явно указать). TypeScript для всего нового кода. Линт: ESLint + Prettier.

Структура монорепо (минимум):

apps/web — PWA (текущий фронт перенести сюда позже, по желанию).

apps/admin — админка (Vite React).

services/api — NestJS (или FastAPI).

packages/shared — общие типы (DTO/Schema/Types).

Secrets/ENV:

VAPID_PUBLIC_KEY, VAPID_PRIVATE_KEY, VAPID_SUBJECT (Notifications).

DATABASE_URL (PostgreSQL), REDIS_URL (очереди), APP_BASE_URL (PWA origin).

Добавить .env.example в каждый пакет.

iOS/Web Push особенности: Запрашивать разрешения только по пользовательскому действию и только внутри установленного PWA; fallback-UI, если Notification.permission !== 'granted'.

Service Worker: Workbox с clientsClaim:true, skipWaiting:true, пред-кэш базовых ассетов, обработчики push/notificationclick и навигация к deep-link из push.

Метрики/гейты (DoD для PR):

Lighthouse PWA/Perf/Best Practices/Accessibility ≥ 90 headless в CI (web-build).

Типобезопасность (tsc --noEmit) зелёная.

API-контракты (OpenAPI) синхронизированы с фронтом (генерация типов).

E2E smoke (Playwright): подписка/отписка пушей, переход по пушу, создание исследования + ручная рассылка (стаб/фиктивные токены).

Безопасность: CSP, HTTPS-допущения, RBAC (минимум для админки), аудит-лог.

Для каждой группы добавь «Артефакты/DoD» (образец, вставь в соответствующие разделы):

A1/A2/A3 (Продукт/UX):

Артефакты: docs/PRD.md, docs/IA.png (или Mermaid), docs/UI-Kit.md с токенами.

DoD: согласованы KPI и acceptance-критерии, зафиксированы состояния (loading/empty/error), список событий аналитики.

B1 (Data-Model):

Артефакты: services/api/prisma/schema.prisma или migrations/*.sql; ER-диаграмма (docs/ER.md).

DoD: таблицы User, Profile, Consent, PrescreenerAnswer, Study, Invitation, Participation, Reward, DeviceSubscription, AuditEvent; индексы по endpoint, study_id+user_id, created_at, частичные индексы по status.

B2 (API):

Артефакты: services/api/openapi.yaml, DTO/валидаторы; генерация типов в packages/shared.

DoD: REST эндпоинты (см. ниже), пагинация, rate-limits, базовая аутентификация для админки.

B3 (Notifications/Web Push):

Артефакты: services/notify (Node + web-push), .env.example, дока docs/notifications.md.

DoD: POST /api/subscriptions, DELETE /api/subscriptions/:id, POST /api/notify (сегмент, текст, url), worker-обработчики в SW.

B4 (CI/CD):

Артефакты: .github/workflows/*, Lighthouse-джоб, деплой фронта (Pages) и API (Render/Vercel/Fly).

C1–C4 (PWA):

Артефакты: страницы, маршрутизация (TanStack Router), SW, офлайн-экраны, события телеметрии.

DoD: анимации/состояния по гайдам, доступность (aria/контраст).

D1–D3 (Админка):

Артефакты: CRUD исследований, таргетинг/квоты, запуск рассылок, экспорт CSV.

DoD: роли, логирование действий (AuditEvent).

E1–E3 (Нормативка/Тексты/QA):

Артефакты: legal/*, шаблоны писем/пушей, тест-план + автотесты (Playwright).

DoD: чек-листы для iOS/Android/desktop, Lighthouse ≥ 90.
---

## Фазы и параллельность
1. **Фаза 0: Инициализация (последовательно)**
   - Product-Discovery, UX-Архитектура.
2. **Фаза 1: Дизайн и Бэкенд-Контур (параллельно)**
   - Дизайн-система/UX, Архитектура БД/API, DevOps (скелет CI/CD).
3. **Фаза 2: Реализация MVP (частично параллельно)**
   - PWA-Фронтенд, Push-уведомления, Админка-MVP, Импорт анкет (iframe), Качество/Антифрод (скелет).
4. **Фаза 3: Core (параллельно с зависимостями)**
   - Квоты/Страты/Матчинг, Награды и Выплаты, Дашборды, Сегменты.
5. **Фаза 4: Growth**
   - Нативные формы с логикой, локализация, рефералка, API/вебхуки, расширенный антифрод.

---

## Группа A — Продукт и UX

### A1. Product-Discovery Agent
**Задача:** уточнить цели, KPI, риски, сценарии.  
**Вход:** черновой план, стейкхолдеры.  
**Выход:** PRD v1, список метрик.  
**Промпт:**  
«Собери PRD для MAR PWA: цели, персоны (респондент/оператор), ключевые флоу, KPI, ограничения iOS PWA, риски и способы снижения. Итог — структурированный документ с acceptance-критериями.»

### A2. UX-Архитектор Agent
**Задача:** информационная архитектура и флоу.  
**Выход:** карта экранов, флоу, навигация mobile/desktop.  
**Промпт:**  
«Построй IA и пользовательские флоу MAR: Первичный запуск, Профиль/Прескрин, Лента приглашений, Анкета, Награды, Поддержка. Определи состояния (loading/empty/error) и safe-area правила.»

### A3. UI-Kit / Дизайн-система Agent
**Задача:** дизайн-токены, компоненты, тема.  
**Выход:** Figma-библиотека/описание токенов.  
**Промпт:**  
«Собери UI-kit: цвета, типографика, spacing, тёмная тема; компоненты (AppBar, Drawer, Card, Button, List, Form, Toast, Modal). Дай гайды по доступности (WCAG) и примеры состояний.»

---

## Группа B — Архитектура и Бэкенд

### B1. Data-Model / DB Agent
**Задача:** схема БД и миграции.  
**Выход:** ER-диаграмма, SQL миграции.  
**Промпт:**  
«Спроектируй Postgres схему для MAR: User, Profile, Consent, PrescreenerAnswer, Study, Invitation, Participation, Reward, DeviceSubscription, AuditEvent. Опиши индексы, внешние ключи, стратегии миграций.»

### B2. API Agent (REST/GraphQL)
**Задача:** контракт API, авторизация, пагинация.  
**Выход:** OpenAPI/GraphQL-схема.  
**Промпт:**  
«Определи REST/GraphQL эндпоинты для профиля, прескрина, исследований, приглашений, статусов участия, вознаграждений, пуш-подписок. Укажи схемы запрос/ответ, коды ошибок, rate-limits.»

### B3. Notifications (Web Push) Agent
**Задача:** сервер отправки уведомлений.  
**Выход:** сервис с VAPID-ключами, worker-обработчики.  
**Промпт:**  
«Реализуй сервис Web Push: хранение подписок, массовая отправка по сегментам, TTL, обработка отказов. Дай код фрагментов для service worker (push, notificationclick).»

### B4. DevOps / CI-CD Agent
**Задача:** пайплайны, окружения, деплой.  
**Выход:** GitHub Actions, деплой фронта и апи.  
**Промпт:**  
«Настрой CI/CD: линт/тест/сборка, деплой фронта в GitHub/Cloudflare Pages, бэкенда в Vercel/Render. Артефакты, версии, секреты, откаты.»

---

## Группа C — Фронтенд PWA

### C1. PWA Shell Agent
**Задача:** каркас приложения.  
**Выход:** App shell, routing, SW (Workbox).  
**Промпт:**  
«Создай app-shell: AppBar, Drawer, адаптивная сетка, маршруты (#home/#profile/#studies/#rewards/#support), Workbox-кэш, офлайн экраны.»

### C2. Profile & Prescreen Agent
**Задача:** формы, валидации, сохранение.  
**Выход:** страницы профиля/прескрина, API-интеграция.  
**Промпт:**  
«Сделай формы профиля (имя, возраст, пол, город, профессия, контакты) и прескрина (редактируемые блоки). Валидации, автосохранение, версия ответов.»

### C3. Invitations Feed Agent
**Задача:** лента и карточки исследований.  
**Выход:** фильтры/сортировки, карточки, CTA.  
**Промпт:**  
«Реализуй ленту приглашений: карточки (тема, время, вознаграждение, дедлайн), фильтры, «Принять участие», смена статусов и трекинг событий.»

### C4. Survey Embed / Native Forms Agent
**Задача:** встраивание анкет (MVP) + задел под нативные формы.  
**Выход:** модуль iframe с обработкой статусов, интерфейсы для будущих нативных форм.  
**Промпт:**  
«Сделай модуль Survey: iframe с пост-сообщениями/обработкой возврата; интерфейсы для нативных форм (шаги, условная логика).»

### C5. Rewards Agent
**Задача:** баланс, транзакции, статусы выплат.  
**Выход:** экран наград, таблица истории.  
**Промпт:**  
«Сверстай экран „Награды“: баланс, «в ожидании», «начислено», история. Заглушки под интеграцию с выплатами.»

---

## Группа D — Админ-панель

### D1. Studies Admin Agent
**Задача:** CRUD исследований, таргетинг, квоты.  
**Выход:** формы создания/редактирования, фильтры/квоты.  
**Промпт:**  
«Сделай админ-форму исследования: поля (тема, ссылка, длительность, вознаграждение, дедлайн), таргетинг по атрибутам, квоты со стратами; статусы и превью карточки.»

### D2. Audience & Segments Agent
**Задача:** поиск респондентов, сегменты.  
**Выход:** таблицы/фильтры, сохранённые сегменты.  
**Промпт:**  
«Реализуй раздел „Аудитория“: поиск по атрибутам/прескринам, сохранённые сегменты, экспорт CSV.»

### D3. Invites & Campaigns Agent
**Задача:** рассылки приглашений (push/e-mail), лимиты.  
**Выход:** редактор кампаний, статусы отправки.  
**Промпт:**  
«Сделай редактор кампаний приглашений: выбор сегмента/квот, превью уведомления, лимит частоты, запуск, мониторинг доставок.»

### D4. Quality & Anti-Fraud Agent
**Задача:** контроль качества и подозрительная активность.  
**Выход:** отчёты по дубликатам, таймингам, „mismatch“.  
**Промпт:**  
«Добавь раздел „Качество“: метрики скорости, дубликаты устройств, флаги „mismatch“, экспорт отчётов.»

### D5. Payouts Agent (этап 2)
**Задача:** управление начислениями и выплатами.  
**Выход:** таблицы выплат, статусы, выгрузки.  
**Промпт:**  
«Сделай раздел „Выплаты“: правила, статусы, CSV-выгрузки; заглушки интеграций.»

---

## Группа E — Нормативка, Тексты, QA

### E1. Legal/GDPR Agent
**Задача:** согласия/политики, DSR-процессы.  
**Выход:** политика приватности, тексты согласий, регламенты запросов субъекта.  
**Промпт:**  
«Сформируй политику приватности, тексты согласий (Art.6/7), процедуры выгрузки/удаления данных и сроки хранения.»

### E2. Copywriter Agent
**Задача:** микрокопи и e-mail шаблоны.  
**Выход:** тексты интерфейса, письма-приглашения/напоминания.  
**Промпт:**  
«Напиши короткие, понятные тексты для PWA и шаблоны e-mail/пуш-уведомлений (RU/EN), учитывая тон-оф-войс и приватность.»

### E3. QA Agent
**Задача:** тест-план, чек-листы, авто-тесты.  
**Выход:** тест-кейсы, Cypress/Playwright скрипты, отчёты.  
**Промпт:**  
«Подготовь E2E тест-план: iOS/Android/desktop, Lighthouse ≥ 90, сценарии подписки на push, прохождение анкеты, корректность квот.»

---

## Запуск и зависимости
- **Сразу (последовательно):** A1 → A2 → A3.  
- **Параллельно после A3:** B1, B2, B4, C1.  
- **После B1/B2:** C2, C3, D1, D2.  
- **После C1/C3 и B3:** Invites & Campaigns (D3) и Notifications.  
- **Core:** матчинг/квоты (D1 расширение), Rewards (C5/D5), Quality (D4).

---

## Формат отчётности агента
Каждый агент возвращает: «что сделал», «артефакты/ссылки», «блокеры», «следующие шаги». Менеджер синхронизирует зависимости и перезапускает отстающие задачи.
